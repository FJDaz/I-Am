<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Assistant Enfance Amiens – Overlay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        --assistant-bg: rgba(18, 18, 18, 0.92);
        --assistant-border: rgba(255, 255, 255, 0.1);
        --assistant-text: #f9fafb;
        --assistant-muted: rgba(249, 250, 251, 0.7);
        --assistant-accent: #3b82f6;
        --assistant-accent-hover: #2563eb;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Helvetica Neue", sans-serif;
      }

      #assistant-toggle {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 2147483000;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 999px;
        border: 1px solid var(--assistant-border);
        background: var(--assistant-bg);
        color: var(--assistant-text);
        cursor: pointer;
        box-shadow: 0 12px 36px -16px rgba(0, 0, 0, 0.65);
        backdrop-filter: blur(16px);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      #assistant-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 36px -16px rgba(37, 99, 235, 0.45);
      }

      #assistant-overlay {
        position: fixed;
        inset: 16px;
        max-width: min(520px, 92vw);
        margin-left: auto;
        z-index: 2147483646;
        display: none;
        flex-direction: column;
        border-radius: 18px;
        background: var(--assistant-bg);
        border: 1px solid var(--assistant-border);
        color: var(--assistant-text);
        box-shadow: 0 24px 64px -32px rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(20px);
        overflow: hidden;
      }

      #assistant-overlay.active {
        display: flex;
      }

      .assistant-header {
        padding: 20px 24px 16px;
        border-bottom: 1px solid var(--assistant-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .assistant-header h1 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .assistant-close {
        border: none;
        background: transparent;
        color: var(--assistant-muted);
        font-size: 1.125rem;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .assistant-close:hover {
        color: var(--assistant-text);
      }

      .assistant-main {
        display: flex;
        flex-direction: column;
        gap: 16px;
        padding: 20px 24px 24px;
        height: 100%;
      }

      #question-input {
        min-height: 96px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--assistant-border);
        background: rgba(255, 255, 255, 0.04);
        color: var(--assistant-text);
        resize: vertical;
        font: inherit;
      }

      #question-input:focus {
        outline: 2px solid rgba(59, 130, 246, 0.35);
        outline-offset: 2px;
      }

      #submit-button {
        align-self: flex-end;
        padding: 10px 18px;
        border-radius: 999px;
        background: var(--assistant-accent);
        color: #fff;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      #submit-button:hover {
        background: var(--assistant-accent-hover);
      }

      #submit-button:disabled {
        background: rgba(59, 130, 246, 0.4);
        cursor: not-allowed;
      }

      #answer,
      #sources {
        display: none;
        border-radius: 12px;
        padding: 16px 18px;
        border: 1px solid var(--assistant-border);
        background: rgba(255, 255, 255, 0.04);
        line-height: 1.55;
        white-space: pre-wrap;
      }

      #answer p {
        margin: 0 0 12px;
      }

      #sources ul {
        padding-left: 20px;
        margin: 8px 0 0;
      }

      #sources a {
        color: var(--assistant-accent);
        text-decoration: none;
      }

      #sources a:hover {
        text-decoration: underline;
      }

      .assistant-info {
        font-size: 0.78rem;
        color: var(--assistant-muted);
        text-align: center;
      }

      @media (max-width: 680px) {
        #assistant-overlay {
          inset: 0;
          border-radius: 0;
          max-width: none;
        }
      }
    </style>
  </head>
  <body>
    <button id="assistant-toggle" type="button" aria-expanded="false">
      Assistant Enfance Amiens
    </button>

    <aside id="assistant-overlay" role="dialog" aria-modal="true">
      <header class="assistant-header">
        <h1>Assistant Enfance Amiens</h1>
        <button class="assistant-close" type="button" aria-label="Fermer">
          ✕
        </button>
      </header>

      <main class="assistant-main">
        <label for="question-input">Pose une question :</label>
        <textarea
          id="question-input"
          placeholder="Exemple : Quel est le prix de la cantine pendant les vacances de Noël ?"
        ></textarea>
        <button id="submit-button" type="button">Rechercher</button>

        <section id="answer" aria-live="polite"></section>
        <section id="sources">
          <strong>Sources :</strong>
          <ul id="sources-list"></ul>
        </section>

        <p class="assistant-info">
          Les réponses locales sont calculées côté navigateur à partir d'un
          corpus exporté depuis le site d'Amiens Métropole. Configure Cursor +
          CURSOR_API_KEY côté backend pour des résultats RAG temps réel.
        </p>
      </main>
    </aside>

    <script>
      const TOGGLE = document.getElementById("assistant-toggle");
      const OVERLAY = document.getElementById("assistant-overlay");
      const CLOSE = OVERLAY.querySelector(".assistant-close");
      const QUESTION = document.getElementById("question-input");
      const SUBMIT = document.getElementById("submit-button");
      const ANSWER = document.getElementById("answer");
      const SOURCES = document.getElementById("sources");
      const SOURCES_LIST = document.getElementById("sources-list");

      let SEGMENTS = [];

      TOGGLE.addEventListener("click", () => {
        const isOpen = OVERLAY.classList.toggle("active");
        TOGGLE.setAttribute("aria-expanded", String(isOpen));
        if (isOpen) {
          QUESTION.focus();
        }
      });

      CLOSE.addEventListener("click", () => {
        OVERLAY.classList.remove("active");
        TOGGLE.setAttribute("aria-expanded", "false");
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          OVERLAY.classList.remove("active");
          TOGGLE.setAttribute("aria-expanded", "false");
        }
      });

      async function loadSegments() {
        const response = await fetch("./data/corpus_segments.json");
        if (!response.ok) {
          throw new Error("Impossible de charger le corpus local");
        }
        SEGMENTS = await response.json();
      }

      function tokenize(text) {
        return text
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .split(/\W+/)
          .filter((token) => token.length > 2);
      }

      function scoreSegment(questionTokens, segment) {
        const { content } = segment;
        if (!content) return 0;

        const tokens = tokenize(content);
        if (!tokens.length) return 0;

        let matches = 0;
        const uniqueTokens = new Set(tokens);
        for (const token of questionTokens) {
          if (uniqueTokens.has(token)) {
            matches += 1;
          }
        }

        const ratio = matches / questionTokens.length;
        const density = matches / uniqueTokens.size;

        return matches + ratio + density;
      }

      function extractSnippet(content, questionTokens) {
        const normalized = content.replace(/\s+/g, " ").trim();
        if (normalized.length <= 420) {
          return normalized;
        }

        let bestIndex = 0;
        let bestScore = -Infinity;
        const lowerContent = normalized.toLowerCase();

        for (const token of questionTokens) {
          const index = lowerContent.indexOf(token);
          if (index !== -1) {
            const left = Math.max(index - 180, 0);
            const right = Math.min(index + 240, normalized.length);
            const snippet = normalized.slice(left, right);
            const snippetTokens = tokenize(snippet);
            const score = questionTokens.filter((qt) =>
              snippetTokens.includes(qt)
            ).length;

            if (score > bestScore) {
              bestScore = score;
              bestIndex = index;
            }
          }
        }

        const start = Math.max(bestIndex - 200, 0);
        const end = Math.min(start + 420, normalized.length);
        let snippet = normalized.slice(start, end);
        if (start > 0) snippet = "…" + snippet;
        if (end < normalized.length) snippet = snippet + "…";
        return snippet;
      }

      function rankSegments(question) {
        const questionTokens = tokenize(question);
        if (!questionTokens.length) return [];

        const scored = SEGMENTS.map((segment) => ({
          ...segment,
          score: scoreSegment(questionTokens, segment),
        })).filter((segment) => segment.score > 0);

        scored.sort((a, b) => b.score - a.score);
        return scored.slice(0, 3);
      }

      async function handleSubmit() {
        const question = QUESTION.value.trim();
        if (!question) return;

        SUBMIT.disabled = true;
        SUBMIT.textContent = "Recherche…";
        ANSWER.style.display = "none";
        SOURCES.style.display = "none";
        SOURCES_LIST.innerHTML = "";

        try {
          if (!SEGMENTS.length) {
            await loadSegments();
          }

          const ranked = rankSegments(question);
          if (!ranked.length) {
            ANSWER.innerHTML =
              "<p>Je n'ai pas trouvé de passage pertinent dans le corpus local.</p>";
            ANSWER.style.display = "block";
            SUBMIT.disabled = false;
            SUBMIT.textContent = "Rechercher";
            return;
          }

          const answerHtml = ranked
            .map((segment) => {
              const snippet = extractSnippet(segment.content, tokenize(question));
              return `
                <article>
                  <header>
                    <strong>${segment.label}</strong>
                  </header>
                  <p>${snippet}</p>
                  ${
                    segment.url
                      ? `<p><a href="${segment.url}" target="_blank" rel="noopener noreferrer">→ Consulter sur amiens.fr</a></p>`
                      : ""
                  }
                </article>
              `;
            })
            .join("<hr>");

          ANSWER.innerHTML = answerHtml;
          ANSWER.style.display = "block";

          ranked.forEach((segment) => {
            const li = document.createElement("li");
            if (segment.url) {
              const anchor = document.createElement("a");
              anchor.href = segment.url;
              anchor.target = "_blank";
              anchor.rel = "noopener noreferrer";
              anchor.textContent = segment.label;
              li.appendChild(anchor);
            } else {
              li.textContent = segment.label;
            }
            SOURCES_LIST.appendChild(li);
          });

          SOURCES.style.display = "block";
        } catch (error) {
          console.error(error);
          ANSWER.innerHTML =
            "<p>Une erreur s'est produite. Vérifie la console navigateur pour plus de détails.</p>";
          ANSWER.style.display = "block";
        } finally {
          SUBMIT.disabled = false;
          SUBMIT.textContent = "Rechercher";
        }
      }

      SUBMIT.addEventListener("click", handleSubmit);
      QUESTION.addEventListener("keydown", (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          handleSubmit();
        }
      });
    </script>
  </body>
</html>

